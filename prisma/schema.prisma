generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Mode {
  SCHEDULED
  MAKEUP
  MANUAL
}

enum Type {
  TEST
  PRACTICE
  REMEDIATION
  PLACEMENT
}

enum AssignmentTargetKind {
  ASSESSMENT     // question-based, one attempt (Attempt + AttemptItems)
  PRACTICE_TIME  // time-based requirement, tracked via PracticeSession + rollups
}

enum RecipientRule {
  ALL
  NOT_MASTERED_DEPENDENCY // includes missed + not-mastery from dependency assignment
}

enum Operation {
  ADD
  SUB
  MUL
  DIV
}

enum Modifier {
  DECIMAL
  FRACTION
}

model Assignment {
  id            Int      @id @default(autoincrement())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  classroomId   Int
  Classroom     Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)

  // What this assignment represents
  type          Type                @default(TEST)
  mode          Mode                @default(SCHEDULED)
  targetKind    AssignmentTargetKind @default(ASSESSMENT)

  // Scheduling window
  opensAt       DateTime
  closesAt      DateTime?
  windowMinutes Int      @default(4)

  // Assessment configuration (targetKind = ASSESSMENT)
  numQuestions  Int      @default(12)

  // Operation context (used by ASSESSMENT; optional for PRACTICE_TIME if you want general practice)
  operation     Operation?

  // Practice-time configuration (targetKind = PRACTICE_TIME)
  durationMinutes Int?

  // Schedule-run linking
  scheduleId    Int?
  Schedule      AssignmentSchedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  runDate       DateTime?

  // Makeups / parent-child relation (optional)
  parentAssignmentId Int?
  ParentAssignment   Assignment?  @relation("AssignmentParent", fields: [parentAssignmentId], references: [id], onDelete: SetNull)
  ChildMakeups       Assignment[] @relation("AssignmentParent")

  // Attempts / targeting
  Attempt      Attempt[]
  recipients   AssignmentRecipient[]
  ScheduleRuns AssignmentScheduleRun[]

  @@index([classroomId])
  @@index([scheduleId])
  @@index([closesAt])
  @@index([classroomId, runDate])
  @@index([classroomId, type])
  @@index([classroomId, opensAt])
  @@index([scheduleId, runDate])
}

model AssignmentSchedule {
  id               Int      @id @default(autoincrement())
  classroomId      Int
  Classroom        Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)

  isActive         Boolean  @default(true)
  days             String[]
  opensAtLocalTime String

  // For schedules that create assignments, you still want a “window”
  // (even PRACTICE_TIME will use closesAt = opensAt + durationMinutes)
  windowMinutes    Int      @default(4)

  // What this schedule creates
  targetKind       AssignmentTargetKind @default(ASSESSMENT)

  // For ASSESSMENT schedules
  type             Type?        // e.g. TEST, PRACTICE, REMEDIATION
  numQuestions     Int          @default(12)
  operation        Operation?

  // For PRACTICE_TIME schedules
  durationMinutes  Int?

  // Dependency scheduling (practice-after-test)
  dependsOnScheduleId Int?
  DependsOnSchedule   AssignmentSchedule? @relation("ScheduleDependency", fields: [dependsOnScheduleId], references: [id], onDelete: SetNull)
  Dependents          AssignmentSchedule[] @relation("ScheduleDependency")

  offsetMinutes     Int           @default(0)

  // Recipient selection for dependent schedules
  recipientRule     RecipientRule @default(ALL)

  Assignments Assignment[]
  Runs        AssignmentScheduleRun[]

  @@index([classroomId])
  @@index([dependsOnScheduleId])
}

model AssignmentScheduleRun {
  id           Int      @id @default(autoincrement())
  scheduleId   Int
  runDate      DateTime
  assignmentId Int?
  createdAt    DateTime @default(now())

  Schedule   AssignmentSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  Assignment Assignment?        @relation(fields: [assignmentId], references: [id], onDelete: SetNull)

  isSkipped  Boolean   @default(false)
  skippedAt  DateTime?
  skipReason String?

  @@unique([scheduleId, runDate])
  @@index([scheduleId])
  @@index([runDate])
}

model AssignmentRecipient {
  assignmentId Int
  studentId    Int
  createdAt    DateTime @default(now())

  Assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  Student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@id([assignmentId, studentId])
  @@index([studentId])
  @@index([assignmentId])
}

model Attempt {
  id           Int      @id @default(autoincrement())
  studentId    Int
  assignmentId Int

  score        Int
  total        Int

  startedAt    DateTime @default(now())
  completedAt  DateTime?

  // Snapshot at time (supports multi-operation progression)
  operationAtTime Operation?
  levelAtTime     Int?
  maxNumberAtTime Int?

  Assignment  Assignment    @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  Student     Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  AttemptItem AttemptItem[]

  @@unique([studentId, assignmentId])
  @@index([assignmentId])
  @@index([studentId])
  @@index([studentId, completedAt])
  @@index([assignmentId, completedAt])
}

model AttemptItem {
  id          Int      @id @default(autoincrement())
  attemptId   Int

  // Snapshot of generated prompt (no Question table)
  operation    Operation
  operandA     Int
  operandB     Int
  correctAnswer Int

  // Student response
  givenAnswer  Int
  isCorrect    Boolean

  Attempt     Attempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@index([attemptId])
}

model PracticeSession {
  id             Int      @id @default(autoincrement())
  studentId       Int
  startedAt       DateTime @default(now())
  endedAt         DateTime?
  durationSeconds Int      @default(0)

  // Snapshot context for analytics and crediting practice-time assignments
  operationAtTime Operation
  levelAtTime     Int
  maxNumberAtTime Int      @default(12)

  Student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([startedAt])
  @@index([studentId, startedAt])
}

model Classroom {
  id                 Int      @id @default(autoincrement())
  name               String
  teacherId          Int
  timeZone           String   @default("America/Los_Angeles")

  Teacher            Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  Student            Student[]
  Assignment         Assignment[]
  AssignmentSchedule AssignmentSchedule[]

  progressionPolicy  ClassroomProgressionPolicy?

  @@index([teacherId])
}

model Student {
  id          Int      @id @default(autoincrement())
  name        String
  username    String   @unique
  passwordHash String

  classroomId Int
  Classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  setupCodeHash      String?
  setupCodeExpiresAt DateTime?
  mustSetPassword    Boolean  @default(true)

  assignments AssignmentRecipient[]
  Attempt     Attempt[]
  progress    StudentProgress[]
  sessions    StudentSession[]
  practiceSessions PracticeSession[]

  @@index([classroomId])
}

model Teacher {
  id           Int      @id @default(autoincrement())
  name         String
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  Classroom    Classroom[]
  sessions     TeacherSession[]
  entitlement  TeacherEntitlement?
}

model TeacherSession {
  id        String   @id @default(cuid())
  token     String   @unique
  teacherId Int
  teacher   Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([teacherId])
  @@index([expiresAt])
  @@map("TeacherSession")
}

model StudentSession {
  id        String   @id @default(cuid())
  token     String   @unique
  studentId Int
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([studentId])
  @@index([expiresAt])
  @@map("StudentSession")
}

enum TeacherPlan {
  TRIAL
  PRO
  SCHOOL
}

enum EntitlementStatus {
  ACTIVE
  EXPIRED
  CANCELED
}

model TeacherEntitlement {
  id        Int     @id @default(autoincrement())
  teacherId Int     @unique
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  plan   TeacherPlan       @default(TRIAL)
  status EntitlementStatus @default(ACTIVE)

  trialEndsAt          DateTime?
  stripeCustomerId     String?
  stripeSubscriptionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([plan])
  @@index([status])
}

model ClassroomProgressionPolicy {
  id                Int       @id @default(autoincrement())
  classroomId       Int       @unique
  classroom         Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)

  enabledOperations Operation[]
  operationOrder    Operation[]
  maxNumber         Int      @default(12)

  modifierRules     ModifierRule[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([classroomId])
}

model StudentProgress {
  id        Int       @id @default(autoincrement())
  studentId Int
  student   Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  operation Operation
  level     Int       @default(1)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([studentId, operation])
  @@index([studentId])
}

model ModifierRule {
  id        Int      @id @default(autoincrement())
  policyId  Int
  policy    ClassroomProgressionPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  modifier   Modifier
  operations Operation[]
  minLevel   Int
  propagate  Boolean  @default(false)
  enabled    Boolean  @default(true)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([policyId])
}